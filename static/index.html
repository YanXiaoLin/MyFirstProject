<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>iwhereGIS 网格数据引擎 - Cesium 可视化</title>
    <script src="https://cesium.com/downloads/cesiumjs/releases/1.111/Build/Cesium/Cesium.js"></script>
    <link href="https://cesium.com/downloads/cesiumjs/releases/1.111/Build/Cesium/Widgets/widgets.css" rel="stylesheet">
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            background: #f0f0f0;
        }
        
        #cesiumContainer {
            width: 100%;
            height: 100vh;
            position: relative;
        }
        
        .control-panel {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(255, 255, 255, 0.9);
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            max-width: 350px;
        }
        
        .control-panel h3 {
            margin: 0 0 15px 0;
            color: #333;
            font-size: 16px;
        }
        
        .form-group {
            margin-bottom: 10px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
            font-size: 12px;
        }
        
        .form-group input, .form-group select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 12px;
            box-sizing: border-box;
        }
        
        .btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            margin-right: 5px;
            margin-bottom: 5px;
        }
        
        .btn:hover {
            background: #0056b3;
        }
        
        .btn-success {
            background: #28a745;
        }
        
        .btn-success:hover {
            background: #1e7e34;
        }
        
        .btn-warning {
            background: #ffc107;
            color: #212529;
        }
        
        .btn-warning:hover {
            background: #e0a800;
        }
        
        .status {
            margin-top: 10px;
            padding: 8px;
            border-radius: 4px;
            font-size: 12px;
        }
        
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .status.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        .grid-info {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(255, 255, 255, 0.9);
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            max-width: 300px;
            font-size: 12px;
        }
        
        .grid-info h4 {
            margin: 0 0 10px 0;
            color: #333;
        }
        
        .grid-info p {
            margin: 5px 0;
            color: #666;
        }
        
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
            color: #666;
        }
        
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #007bff;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div id="cesiumContainer">
        <div class="control-panel">
            <h3>网格数据引擎控制面板</h3>
            <div class="form-group">
                <label>经度范围:</label>
                <input type="number" id="lonMin" placeholder="最小经度" value="114.0" step="0.001">
                <input type="number" id="lonMax" placeholder="最大经度" value="114.01" step="0.001">
            </div>
            <div class="form-group">
                <label>纬度范围:</label>
                <input type="number" id="latMin" placeholder="最小纬度" value="22.5" step="0.001">
                <input type="number" id="latMax" placeholder="最大纬度" value="22.51" step="0.001">
            </div>
            <div class="form-group">
                <label>高度范围 (米):</label>
                <input type="number" id="altMin" placeholder="最小高度" value="0" step="10">
                <input type="number" id="altMax" placeholder="最大高度" value="1000" step="10">
            </div>
            <div class="form-group">
                <label>网格级别:</label>
                <select id="gridLevel">
                    <option value="6">6级 (粗粒度)</option>
                    <option value="7">7级 (中等粒度)</option>
                    <option value="8" selected>8级 (细粒度)</option>
                    <option value="9">9级 (超细粒度)</option>
                </select>
            </div>
            <button class="btn btn-success" onclick="generateGrids()">生成网格</button>
            <button class="btn btn-warning" onclick="clearGrids()">清除网格</button>
            <button class="btn" onclick="showRoutePlanning()">航线规划</button>
            <button class="btn" onclick="loadRoutes()">加载航线</button>
            <button class="btn" onclick="loadRouteGridsWithRisk()">加载航线网格及风险</button>
            <!-- 加载航线网格及风险按钮已存在 -->
            <hr>
            <h3>API 测试区</h3>
            <div class="form-group">
                <button class="btn" onclick="healthCheck()">健康检查</button>
                <span id="healthResult"></span>
            </div>
            <div class="form-group">
                <label>网格编码查询:</label>
                <input type="text" id="queryGridCode" placeholder="输入网格编码">
                <button class="btn" onclick="queryGrid()">查询</button>
                <pre id="queryGridResult"></pre>
            </div>
            <div class="form-group">
                <label>坐标编码:</label>
                <input type="number" id="encodeLon" placeholder="经度" step="0.0001">
                <input type="number" id="encodeLat" placeholder="纬度" step="0.0001">
                <input type="number" id="encodeAlt" placeholder="高程" step="1">
                <input type="number" id="encodeLevel" placeholder="级别" value="8" min="1" max="16">
                <button class="btn" onclick="encodeCoord()">编码</button>
                <pre id="encodeResult"></pre>
            </div>
            <div class="form-group">
                <label>更新属性:</label>
                <input type="text" id="attrGridCode" placeholder="网格编码">
                <input type="text" id="attrCategory" placeholder="属性类别">
                <input type="text" id="attrKey" placeholder="属性名">
                <input type="text" id="attrValue" placeholder="属性值">
                <button class="btn" onclick="updateAttribute()">更新</button>
                <pre id="updateAttrResult"></pre>
            </div>
            <div class="form-group">
                <label>网格搜索:</label>
                <input type="text" id="searchCategory" placeholder="属性类别">
                <input type="text" id="searchKey" placeholder="属性名">
                <input type="text" id="searchValue" placeholder="属性值">
                <button class="btn" onclick="searchGrids()">搜索</button>
                <pre id="searchResult"></pre>
            </div>
            <div class="form-group">
                <button class="btn" onclick="getStatistics()">统计信息</button>
                <pre id="statResult"></pre>
            </div>
            <div id="status" class="status" style="display: none;"></div>
            <div id="loading" class="loading">
                <div class="spinner"></div>
                <div>处理中...</div>
            </div>
        </div>
        
        <div class="grid-info" id="gridInfo" style="display: none;">
            <h4>网格信息</h4>
            <p>网格数量: <span id="gridCount">0</span></p>
            <p>覆盖面积: <span id="gridArea">0</span> km²</p>
            <p>平均大小: <span id="avgGridSize">0</span> m²</p>
            <div id="selectedGridInfo" style="margin-top:10px;"></div>
        </div>
    </div>

    <script>
window.onload = function() {
    let loadedRouteEntities = [];
    // API 基础URL
    const API_BASE_URL = 'http://localhost:5000/api';
    let gridEntities = [];
    let routeEntities = [];
    const viewer = new Cesium.Viewer('cesiumContainer', {
        // imageryProvider: ... 可选
            baseLayer: new Cesium.ImageryLayer(
          new Cesium.UrlTemplateImageryProvider({
            url: 'https://services.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}.png',
            maximumLevel: 18,
          })
        ),
        homeButton: false,
        sceneModePicker: false,
        baseLayerPicker: false,
        navigationHelpButton: false,
        animation: false,
        timeline: false,
        fullscreenButton: false,
        geocoder: false
    });

    // 加载航线经过的所有网格及风险等级（修正版，兼容alt_range为空/异常情况）
    window.loadRouteGridsWithRisk = async function() {
        try {
            setLoading(true);
            showStatus('正在加载航线网格及风险...', 'info');
            // 清除已加载的网格
            gridEntities.forEach(entity => viewer.entities.remove(entity));
            gridEntities = [];
            // 这里以“航道1”为例
            const resp = await fetch(`${API_BASE_URL}/routes/航道1/grids_risk`);
            const data = await resp.json();
            if (!data.success) throw new Error(data.error || '航线网格数据获取失败');
            data.grids.forEach(grid => {
                const bbox = grid.bbox;
                const center = grid.center;
                // 兼容alt_range为null或undefined
                let h0 = 0, h1 = 0;
                if (Array.isArray(grid.alt_range) && grid.alt_range.length === 2) {
                    h0 = Number(grid.alt_range[0]) || 0;
                    h1 = Number(grid.alt_range[1]) || 0;
                }
                // 绘制网格
                const positions = [
                    Cesium.Cartesian3.fromDegrees(bbox[0], bbox[1]),
                    Cesium.Cartesian3.fromDegrees(bbox[2], bbox[1]),
                    Cesium.Cartesian3.fromDegrees(bbox[2], bbox[3]),
                    Cesium.Cartesian3.fromDegrees(bbox[0], bbox[3])
                ];
                const entity = viewer.entities.add({
                    name: `网格 ${grid.code}`,
                    polygon: {
                        hierarchy: positions,
                        material: Cesium.Color.BLUE.withAlpha(0.2),
                        outline: true,
                        outlineColor: Cesium.Color.BLUE,
                        height: h0,
                        extrudedHeight: h1 > h0 ? h1 : h0 + 1 // 保证有厚度
                    },
                    properties: {
                        gridCode: grid.code,
                        riskLevel: grid.risk_level
                    }
                });
                gridEntities.push(entity);
                // 添加中心点
                if (center && Array.isArray(center) && center.length === 2) {
                    const cz = h0 + (h1 - h0) / 2;
                    const centerEntity = viewer.entities.add({
                        position: Cesium.Cartesian3.fromDegrees(center[0], center[1], cz),
                        point: {
                            pixelSize: 7,
                            color: Cesium.Color.RED,
                            outlineColor: Cesium.Color.WHITE,
                            outlineWidth: 2
                        },
                        properties: {
                            gridCode: grid.code,
                            riskLevel: grid.risk_level
                        }
                    });
                    gridEntities.push(centerEntity);
                }
            });
            showStatus('航线网格及风险加载完成', 'success');
        } catch (e) {
            showStatus('航线网格加载失败: ' + e.message, 'error');
        } finally {
            setLoading(false);
        }
    };

    Cesium.Ion.defaultAccessToken = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJqdGkiOiJlMTM4OTAxOS00NGE3LTQ0ZWQtYWY0MC0zZmE5NmU1NGQxMjQiLCJpZCI6Mjk2MzQwLCJpYXQiOjE3NTM5NjAwMzl9.T4p2BUv1kEq4BdZNGLM6LqsjWbxnhYKzt1BaBgY2aAw';
        
        // 设置初始视角到深圳
        viewer.camera.setView({
            destination: Cesium.Cartesian3.fromDegrees(114.0, 22.5, 50000),
            orientation: {
                heading: 0.0,
                pitch: -Cesium.Math.PI_OVER_TWO,
                roll: 0.0
            }
        });
        
        // 显示状态信息
        function showStatus(message, type = 'info') {
            const statusDiv = document.getElementById('status');
            statusDiv.textContent = message;
            statusDiv.className = `status ${type}`;
            statusDiv.style.display = 'block';
            
            setTimeout(() => {
                statusDiv.style.display = 'none';
            }, 5000);
        }
        
        // 显示/隐藏加载状态
        function setLoading(show) {
            document.getElementById('loading').style.display = show ? 'block' : 'none';
        }
        
        // 生成网格
        async function generateGrids() {
            try {
                setLoading(true);
                showStatus('正在生成网格...', 'info');
                
                const data = {
                    lon_min: parseFloat(document.getElementById('lonMin').value),
                    lon_max: parseFloat(document.getElementById('lonMax').value),
                    lat_min: parseFloat(document.getElementById('latMin').value),
                    lat_max: parseFloat(document.getElementById('latMax').value),
                    alt_min: parseFloat(document.getElementById('altMin').value),
                    alt_max: parseFloat(document.getElementById('altMax').value),
                    level: parseInt(document.getElementById('gridLevel').value)
                };
                
                const response = await fetch(`${API_BASE_URL}/grids/generate`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const result = await response.json();
                
                if (result.success) {
                    clearGrids();
                    displayGrids(result.data.grids);
                    updateGridInfo(result.data.grids);
                    showStatus(`成功生成 ${result.data.count} 个网格`, 'success');
                } else {
                    throw new Error(result.error || '生成网格失败');
                }
                
            } catch (error) {
                console.error('生成网格错误:', error);
                showStatus(`生成网格失败: ${error.message}`, 'error');
            } finally {
                setLoading(false);
            }
        }
        
        // 显示网格
        function displayGrids(grids) {
            grids.forEach(grid => {
                const bbox = grid.bbox;
                const center = grid.center;
                // 创建网格边界
                const positions = [
                    Cesium.Cartesian3.fromDegrees(bbox[0], bbox[1]),
                    Cesium.Cartesian3.fromDegrees(bbox[2], bbox[1]),
                    Cesium.Cartesian3.fromDegrees(bbox[2], bbox[3]),
                    Cesium.Cartesian3.fromDegrees(bbox[0], bbox[3])
                ];
                // 添加网格边界线
                const boundaryEntity = viewer.entities.add({
                    name: `网格 ${grid.code}`,
                    polygon: {
                        hierarchy: positions,
                        material: Cesium.Color.BLUE.withAlpha(0.1),
                        outline: true,
                        outlineColor: Cesium.Color.BLUE,
                        height: 0,
                        extrudedHeight: grid.alt_range[1] 
                    },
                    label: {
                        text: grid.code,
                        font: '12px sans-serif',
                        fillColor: Cesium.Color.WHITE,
                        outlineColor: Cesium.Color.BLACK,
                        outlineWidth: 2,
                        style: Cesium.LabelStyle.FILL_AND_OUTLINE,
                        pixelOffset: new Cesium.Cartesian2(0, -10),
                        position: Cesium.Cartesian3.fromDegrees(center[0], center[1], grid.alt_range[1])
                    },
                    properties: {
                        gridCode: grid.code
                    }
                });
                gridEntities.push(boundaryEntity);
                // 添加网格中心点
                const centerEntity = viewer.entities.add({
                    position: Cesium.Cartesian3.fromDegrees(center[0], center[1], grid.alt_range[0]+(grid.alt_range[1] - grid.alt_range[0])/2),
                    point: {
                        pixelSize: 5,
                        color: Cesium.Color.RED,
                        outlineColor: Cesium.Color.WHITE,
                        outlineWidth: 2
                    },
                    properties: {
                        gridCode: grid.code
                    }
                });
                gridEntities.push(centerEntity);
            });
        }
        // 监听点击事件，展示网格编号和风险等级（优先显示已加载的风险信息）
        // 鼠标悬停高亮并显示信息
        let lastHighlighted = null;
        let lastOutlineColor = null;
        viewer.screenSpaceEventHandler.setInputAction(function onMouseMove(movement) {
            const pickedObject = viewer.scene.pick(movement.endPosition || movement.position);
            if (lastHighlighted && lastOutlineColor) {
                // 恢复上一个高亮
                if (lastHighlighted.polygon) lastHighlighted.polygon.outlineColor = lastOutlineColor;
            }
            lastHighlighted = null;
            lastOutlineColor = null;
            if (Cesium.defined(pickedObject) && pickedObject.id && pickedObject.id.properties && pickedObject.id.properties.gridCode) {
                // 高亮边框
                if (pickedObject.id.polygon) {
                    lastHighlighted = pickedObject.id;
                    lastOutlineColor = pickedObject.id.polygon.outlineColor;
                    pickedObject.id.polygon.outlineColor = Cesium.Color.YELLOW;
                }
                // 聚焦到中心
                let center = pickedObject.id.properties.center;
                let alt_range = pickedObject.id.properties.altRange || pickedObject.id.properties.alt_range;
                let cz = 0;
                if (center && Array.isArray(center) && center.length === 2 && alt_range && Array.isArray(alt_range) && alt_range.length === 2) {
                    cz = alt_range[0] + (alt_range[1] - alt_range[0]) / 2;
                    viewer.camera.flyTo({
                        destination: Cesium.Cartesian3.fromDegrees(center[0], center[1], cz + 200),
                        duration: 0.8
                    });
                }
                // 显示信息
                const gridCode = pickedObject.id.properties.gridCode;
                let riskLevel = pickedObject.id.properties.riskLevel;
                if (riskLevel === undefined || riskLevel === null) riskLevel = '未知';
                let info = `网格编码: ${gridCode}\n风险等级: ${riskLevel}`;
                if (center) info += `\n中心经纬度: ${center[0].toFixed(6)}, ${center[1].toFixed(6)}`;
                if (alt_range) info += `\n高程范围: ${alt_range[0]} ~ ${alt_range[1]} m`;
                document.getElementById('selectedGridInfo').textContent = info;
            } else {
                document.getElementById('selectedGridInfo').textContent = '';
            }
        }, Cesium.ScreenSpaceEventType.MOUSE_MOVE);

        // 鼠标点击时也显示详细信息（与悬停一致）
        viewer.screenSpaceEventHandler.setInputAction(function onLeftClick(movement) {
            const pickedObject = viewer.scene.pick(movement.position);
            if (Cesium.defined(pickedObject) && pickedObject.id && pickedObject.id.properties && pickedObject.id.properties.gridCode) {
                const gridCode = pickedObject.id.properties.gridCode;
                let riskLevel = pickedObject.id.properties.riskLevel;
                if (riskLevel === undefined || riskLevel === null) riskLevel = '未知';
                let center = pickedObject.id.properties.center;
                let alt_range = pickedObject.id.properties.altRange || pickedObject.id.properties.alt_range;
                let info = `网格编码: ${gridCode}\n风险等级: ${riskLevel}`;
                if (center) info += `\n中心经纬度: ${center[0].toFixed(6)}, ${center[1].toFixed(6)}`;
                if (alt_range) info += `\n高程范围: ${alt_range[0]} ~ ${alt_range[1]} m`;
                document.getElementById('selectedGridInfo').textContent = info;
            } else {
                document.getElementById('selectedGridInfo').textContent = '';
            }
        }, Cesium.ScreenSpaceEventType.LEFT_CLICK);
        
        // 更新网格信息
        function updateGridInfo(grids) {
            const gridInfo = document.getElementById('gridInfo');
            const gridCount = document.getElementById('gridCount');
            const gridArea = document.getElementById('gridArea');
            const avgGridSize = document.getElementById('avgGridSize');
            
            gridCount.textContent = grids.length;
            
            // 计算总面积
            let totalArea = 0;
            grids.forEach(grid => {
                const bbox = grid.bbox;
                const width = (bbox[2] - bbox[0]) * 111000; // 转换为米
                const height = (bbox[3] - bbox[1]) * 111000;
                totalArea += width * height;
            });
            
            gridArea.textContent = (totalArea / 1000000).toFixed(2); // 转换为平方公里
            avgGridSize.textContent = grids.length > 0 ? (totalArea / grids.length).toFixed(0) : 0;
            
            gridInfo.style.display = 'block';
        }
        
        // 清除网格
        function clearGrids() {
            gridEntities.forEach(entity => {
                viewer.entities.remove(entity);
            });
            gridEntities = [];
            
            routeEntities.forEach(entity => {
                viewer.entities.remove(entity);
            });
            routeEntities = [];
            
            document.getElementById('gridInfo').style.display = 'none';
            showStatus('已清除所有网格和航线', 'info');
        }
        
        // 航线规划
        function showRoutePlanning() {
            const waypoints = prompt('请输入航点坐标 (格式: 经度,纬度,高度;经度,纬度,高度):\n例如: 114.05,22.55,100;114.08,22.58,150');
            
            if (waypoints) {
                calculateRoute(waypoints);
            }
        }
        
        // 计算航线
        async function calculateRoute(waypointsStr) {
            try {
                setLoading(true);
                showStatus('正在计算航线...', 'info');
                
                const waypoints = waypointsStr.split(';').map(wp => {
                    const coords = wp.split(',').map(Number);
                    return coords;
                });
                
                const data = {
                    waypoints: waypoints,
                    level: parseInt(document.getElementById('gridLevel').value)
                };
                
                const response = await fetch(`${API_BASE_URL}/grids/route`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const result = await response.json();
                
                if (result.success) {
                    displayRoute(waypoints, result.data.grid_codes);
                    showStatus(`航线规划完成，经过 ${result.data.count} 个网格`, 'success');
                } else {
                    throw new Error(result.error || '航线规划失败');
                }
                
            } catch (error) {
                console.error('航线规划错误:', error);
                showStatus(`航线规划失败: ${error.message}`, 'error');
            } finally {
                setLoading(false);
            }
        }
        
        // 显示航线
        function displayRoute(waypoints, gridCodes) {
            // 清除之前的航线
            routeEntities.forEach(entity => {
                viewer.entities.remove(entity);
            });
            routeEntities = [];
            
            // 绘制航点连线
            const positions = waypoints.map(wp => 
                Cesium.Cartesian3.fromDegrees(wp[0], wp[1], wp[2])
            );
            
            const routeEntity = viewer.entities.add({
                name: '航线',
                polyline: {
                    positions: positions,
                    width: 3,
                    material: Cesium.Color.YELLOW,
                    clampToGround: false
                }
            });
            
            routeEntities.push(routeEntity);
            
            // 添加航点标记
            waypoints.forEach((wp, index) => {
                const waypointEntity = viewer.entities.add({
                    name: `航点 ${index + 1}`,
                    position: Cesium.Cartesian3.fromDegrees(wp[0], wp[1], wp[2]),
                    point: {
                        pixelSize: 8,
                        color: Cesium.Color.ORANGE,
                        outlineColor: Cesium.Color.WHITE,
                        outlineWidth: 2
                    },
                    label: {
                        text: `WP${index + 1}`,
                        font: '14px sans-serif',
                        fillColor: Cesium.Color.WHITE,
                        outlineColor: Cesium.Color.BLACK,
                        outlineWidth: 2,
                        style: Cesium.LabelStyle.FILL_AND_OUTLINE,
                        pixelOffset: new Cesium.Cartesian2(0, -15)
                    }
                });
                
                routeEntities.push(waypointEntity);
            });
            
            // 高亮航线经过的网格
            gridCodes.forEach(gridCode => {
                const gridEntity = gridEntities.find(entity => 
                    entity.name === `网格 ${gridCode}`
                );
                
                if (gridEntity) {
                    gridEntity.polygon.material = Cesium.Color.RED.withAlpha(0.3);
                    gridEntity.polygon.outlineColor = Cesium.Color.RED;
                }
            });
        }
        
        // 检查API连接
        async function checkApiConnection() {
            try {
                const response = await fetch(`${API_BASE_URL}/health`);
                if (response.ok) {
                    showStatus('API 连接正常', 'success');
                } else {
                    showStatus('API 连接异常', 'error');
                }
            } catch (error) {
                showStatus('无法连接到 API 服务器，请确保服务器已启动', 'error');
            }
        }
        
        // 页面加载完成后检查API连接
        window.addEventListener('load', () => {
            setTimeout(checkApiConnection, 1000);
        });

    // 加载航线并展示
    window.loadRoutes = async function() {
        try {
            setLoading(true);
            showStatus('正在加载航线...', 'info');
            // 清除已加载的航线
            loadedRouteEntities.forEach(entity => viewer.entities.remove(entity));
            loadedRouteEntities = [];
            const resp = await fetch(`${API_BASE_URL}/routes`);
            const data = await resp.json();
            if (!data.success) throw new Error(data.error || '航线数据获取失败');
            data.routes.forEach(route => {
                if (route.points && route.points.length > 1) {
                    // 画polyline
                    const positions = route.points.map(pt => Cesium.Cartesian3.fromDegrees(pt[0], pt[1], pt[2]));
                    const entity = viewer.entities.add({
                        name: `航线-${route.name}`,
                        polyline: {
                            positions: positions,
                            width: 4,
                            material: Cesium.Color.ORANGE,
                            clampToGround: false
                        },
                        description: `航线名称: ${route.name}`
                    });
                    loadedRouteEntities.push(entity);
                    // 画航点
                    route.points.forEach((pt, idx) => {
                        const wpEntity = viewer.entities.add({
                            position: Cesium.Cartesian3.fromDegrees(pt[0], pt[1], pt[2]),
                            point: {
                                pixelSize: 8,
                                color: Cesium.Color.PURPLE,
                                outlineColor: Cesium.Color.WHITE,
                                outlineWidth: 2
                            },
                            label: {
                                text: `R${route.name}-P${idx+1}`,
                                font: '12px sans-serif',
                                fillColor: Cesium.Color.PURPLE,
                                outlineColor: Cesium.Color.WHITE,
                                outlineWidth: 2,
                                style: Cesium.LabelStyle.FILL_AND_OUTLINE,
                                pixelOffset: new Cesium.Cartesian2(0, -15)
                            }
                        });
                        loadedRouteEntities.push(wpEntity);
                    });
                }
            });
            showStatus('航线加载完成', 'success');
        } catch (e) {
            showStatus('航线加载失败: ' + e.message, 'error');
        } finally {
            setLoading(false);
        }
    };
    // API测试区相关函数
    window.healthCheck = async function() {
        try {
            const resp = await fetch(`${API_BASE_URL}/health`);
            document.getElementById('healthResult').textContent = resp.ok ? '正常' : '异常';
        } catch {
            document.getElementById('healthResult').textContent = '无法连接';
        }
    };
    window.queryGrid = async function() {
        const code = document.getElementById('queryGridCode').value;
        if (!code) return;
        try {
            const resp = await fetch(`${API_BASE_URL}/grids/${code}`);
            document.getElementById('queryGridResult').textContent = await resp.text();
        } catch (e) {
            document.getElementById('queryGridResult').textContent = '查询失败';
        }
    };
    window.encodeCoord = async function() {
        const lon = parseFloat(document.getElementById('encodeLon').value);
        const lat = parseFloat(document.getElementById('encodeLat').value);
        const alt = parseFloat(document.getElementById('encodeAlt').value);
        const level = parseInt(document.getElementById('encodeLevel').value);
        if (isNaN(lon) || isNaN(lat) || isNaN(alt) || isNaN(level)) return;
        try {
            const resp = await fetch(`${API_BASE_URL}/grids/encode`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ lon, lat, alt, level })
            });
            document.getElementById('encodeResult').textContent = await resp.text();
        } catch (e) {
            document.getElementById('encodeResult').textContent = '编码失败';
        }
    };
    window.updateAttribute = async function() {
        const code = document.getElementById('attrGridCode').value;
        const category = document.getElementById('attrCategory').value;
        const key = document.getElementById('attrKey').value;
        const value = document.getElementById('attrValue').value;
        if (!code || !category || !key || !value) return;
        try {
            const resp = await fetch(`${API_BASE_URL}/grids/${code}/attributes`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ category, key, value })
            });
            document.getElementById('updateAttrResult').textContent = await resp.text();
        } catch (e) {
            document.getElementById('updateAttrResult').textContent = '更新失败';
        }
    };
    window.searchGrids = async function() {
        const category = document.getElementById('searchCategory').value;
        const key = document.getElementById('searchKey').value;
        const value = document.getElementById('searchValue').value;
        if (!category || !key || !value) return;
        try {
            const resp = await fetch(`${API_BASE_URL}/grids/search`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ category, key, value })
            });
            document.getElementById('searchResult').textContent = await resp.text();
        } catch (e) {
            document.getElementById('searchResult').textContent = '搜索失败';
        }
    };
    window.getStatistics = async function() {
        try {
            const resp = await fetch(`${API_BASE_URL}/statistics`);
            document.getElementById('statResult').textContent = await resp.text();
        } catch (e) {
            document.getElementById('statResult').textContent = '获取失败';
        }
    };
    // 导出全局函数供HTML按钮调用
    window.generateGrids = generateGrids;
    window.clearGrids = clearGrids;
    window.showRoutePlanning = showRoutePlanning;
};
</script>
</body>
</html> 